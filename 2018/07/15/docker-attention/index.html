<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>docker化注意事项 | 鱼塘</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2018-07-15</div></div></div><div class="post-header"><h1>docker化注意事项</h1></div><div class="container post-content"><p>虽然docker化是大势所趋，但是由于docker的缺陷，容器化过程中还是有不少坑要填。</p>
<h3 id="cpu核数获取"><a href="#cpu核数获取" class="headerlink" title="cpu核数获取"></a>cpu核数获取</h3><p>很多情况下我们会用根据cpu核数设置线程数，最后调用的一般都是<code>sysconf(_SC_NPROCESSORS_CONF)</code> / <code>get_nprocs(void)</code> / <code>get_nprocs_conf(void)</code> 等系统调用，最后这些系统调用基本是从 <code>/sys/devices/system/cpu</code>、<code>/sys/devices/system/cpu/online</code> 这两个地方获取到系统核数。</p>
<p>docker 并没有虚拟化 <code>/sys</code> 目录，所以在 docker 里面读到的数据是宿主系统的核数。</p>
<p>因为这些数据都是以文件的形式存的，所以可以通过 <code>fuse</code> hook 对此类文件的 <code>read()</code> 调用，通过 <code>cgroup</code> 计算出实际分配给 docker 的核数并返回。</p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p> 内存通过 <code>sysconf(_SC_PHYS_PAGES)</code> 或者 <code>sysinfo</code> 的方法获取的数据是从内存获取的，所以没法通过 <code>fuse</code> hook 读写的。c 的话建议从<code>/proc/memory</code> 之类的地方获取。java的话，只能设置 jvm 堆大小解决这个问题，不然 jvm 会因为根据宿主系统内存扩大自己的内存，超过 docker 限制后会被 docker 杀掉。</p>
<h3 id="宿主机系统与容器内部的用户权限"><a href="#宿主机系统与容器内部的用户权限" class="headerlink" title="宿主机系统与容器内部的用户权限"></a>宿主机系统与容器内部的用户权限</h3><p>Linux 内核负责管理 uid 和 gid，内核级系统调用时，用于确定是否授予该请求权限。例如当进程尝试写入文件时，内核会检查创建进程的 uid 和 gid，以确定它是否有足够的权限来修改文件。此时没有使用用户名，使用了uid。</p>
<p>当在服务器上运行 Docker 容器时，仍然使用同一个内核内核，uids 和 gids 都由单个内核控制。</p>
<p>linux 中显示的用户名（和组名）不是内核的一部分，而是由外部工具 <code>/etc/passwd</code>、<code>ldap</code>、<code>kerberos</code> 等管理的。所以实际用用户名去授权的话，并不能在宿主机和容器通用。</p>
<p>在一个新的镜像中通过 <code>useradd</code> 创建的用户一般是从 1000 开始递增的。这个时候容器内部 uid 1000 的用户对应的是宿主机 uid 1000 的用户（即使他们拥有不同的用户名），造成即使在用容器中用了不同的用户名，映射到宿主系统中都是uid为1000的用户，对用户的权限做不到比较好的隔离。</p>
<p>比较好的做法应该是预先分配好每个用户的 uid，在 dockerfile 中创建用户的时候也指定 uid，正确的把用户 uid 联系在一起。</p>
<h3 id="时区问题"><a href="#时区问题" class="headerlink" title="时区问题"></a>时区问题</h3><p>网上一般的做法推荐是 <code>docker run</code> 的时候加上 <code>-v /etc/localtime:/etc/localtime:ro</code> 或者在构建镜像的时候加上 <code>RUN echo &quot;Asia/shanghai&quot; &gt; /etc/timezone</code>。</p>
<p>这两种方法其实都存在点问题。</p>
<p>第一种方法挂载 <code>/etc/localtime</code> 后 <code>/etc/localtime</code> 仍然是链到 <code>/usr/share/zoneinfo/UTC</code>。java的话，会判断 <code>/etc/localtime</code> 是不是软链，如果是的话，直接读取链接的内容，从而导致 <code>-v /etc/localtime:/etc/localtime:ro</code> 不起作用。</p>
<p><img src="localtime.jpg" alt="vm"></p>
<p>第二种方法的话，写死了时区，对于存在不同时区的机房的话，也是不适用的。</p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'yihuangcaia';
var disqus_identifier = '2018/07/15/docker-attention/';
var disqus_title = 'docker化注意事项';
var disqus_url = 'http://chellynov.github.io/2018/07/15/docker-attention/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>