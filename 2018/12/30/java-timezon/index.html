<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>docker java 时区 | 鱼塘</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2018-12-30</div></div></div><div class="post-header"><h1>docker java 时区</h1></div><div class="container post-content"><h3 id="升级了centos：7镜像后-java时区又不准了"><a href="#升级了centos：7镜像后-java时区又不准了" class="headerlink" title="升级了centos：7镜像后 java时区又不准了"></a>升级了centos：7镜像后 java时区又不准了</h3><p>之前的文章提到过把镜像的／etc／localtime 删除后挂载本地的就可以解决问题，但是最近更新了centos7的基础镜像，发现时间又少了8个小时，确认了下镜像制作没问题，但是依然出现了，百思不得其解，于是把java获取时区的代码抠出来了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *ETC_TIMEZONE_FILE = <span class="string">"/etc/timezone"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *ZONEINFO_DIR = <span class="string">"/usr/share/zoneinfo"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *DEFAULT_ZONEINFO_FILE = <span class="string">"/etc/localtime"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *</span></div><div class="line"><span class="title">getZoneName</span><span class="params">(<span class="keyword">char</span> *str)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *zidir = <span class="string">"zoneinfo/"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">char</span> *pos = <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)str, zidir);</div><div class="line">    <span class="keyword">if</span> (pos == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> pos + <span class="built_in">strlen</span>(zidir);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Returns a path name created from the given 'dir' and 'name' under</div><div class="line"> * UNIX. This function allocates memory for the pathname calling</div><div class="line"> * malloc(). NULL is returned if malloc() fails.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *</span></div><div class="line"><span class="title">getPathName</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *dir, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span> &#123;</div><div class="line">    <span class="keyword">char</span> *path;</div><div class="line"></div><div class="line">    path = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(dir) + <span class="built_in">strlen</span>(name) + <span class="number">2</span>);</div><div class="line">    <span class="keyword">if</span> (path == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">strcat</span>(<span class="built_in">strcat</span>(<span class="built_in">strcpy</span>(path, dir), <span class="string">"/"</span>), name);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *</span></div><div class="line"><span class="title">findZoneinfoFile</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *dir)</span></div><div class="line">&#123;</div><div class="line">    DIR *dirp = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> stat statbuf;</div><div class="line">    <span class="keyword">struct</span> dirent *dp = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> dirent *entry = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">char</span> *pathname = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">char</span> *dbuf = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">char</span> *tz = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    dirp = opendir(dir);</div><div class="line">    <span class="keyword">if</span> (dirp == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    entry = (<span class="keyword">struct</span> dirent *) <span class="built_in">malloc</span>((<span class="keyword">size_t</span>) pathconf(dir, _PC_NAME_MAX));</div><div class="line">    <span class="keyword">if</span> (entry == <span class="literal">NULL</span>) &#123;</div><div class="line">        (<span class="keyword">void</span>) closedir(dirp);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__linux__) || defined(MACOSX) || (defined(__solaris__) \</span></div><div class="line">    &amp;&amp; (defined(_POSIX_PTHREAD_SEMANTICS) || defined(_LP64)))</div><div class="line">    <span class="keyword">while</span> (readdir_r(dirp, entry, &amp;dp) == <span class="number">0</span> &amp;&amp; dp != <span class="literal">NULL</span>) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">while</span> ((dp = readdir_r(dirp, entry)) != <span class="literal">NULL</span>) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Skip '.' and '..' (and possibly other .* files)</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (dp-&gt;d_name[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Skip "ROC", "posixrules", and "localtime".</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(dp-&gt;d_name, <span class="string">"ROC"</span>) == <span class="number">0</span>)</div><div class="line">            || (<span class="built_in">strcmp</span>(dp-&gt;d_name, <span class="string">"posixrules"</span>) == <span class="number">0</span>)</div><div class="line">#ifdef __solaris__</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Skip the "src" and "tab" directories on Solaris.</div><div class="line">             */</div><div class="line">            || (<span class="built_in">strcmp</span>(dp-&gt;d_name, <span class="string">"src"</span>) == <span class="number">0</span>)</div><div class="line">            || (<span class="built_in">strcmp</span>(dp-&gt;d_name, <span class="string">"tab"</span>) == <span class="number">0</span>)</div><div class="line">#endif</div><div class="line">            || (<span class="built_in">strcmp</span>(dp-&gt;d_name, <span class="string">"localtime"</span>) == <span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        pathname = getPathName(dir, dp-&gt;d_name);</div><div class="line">        <span class="keyword">if</span> (pathname == <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (stat(pathname, &amp;statbuf) == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (S_ISDIR(statbuf.st_mode)) &#123;</div><div class="line">            tz = findZoneinfoFile(buf, size, pathname);</div><div class="line">            <span class="keyword">if</span> (tz != <span class="literal">NULL</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        <span class="comment">// 这里失败 usr share zoneinfo asia  目录下 所有的文件都通不S_ISREG 这个函数</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(statbuf.st_mode) &amp;&amp; (<span class="keyword">size_t</span>)statbuf.st_size == size) &#123;</div><div class="line">            dbuf = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(size);</div><div class="line">            <span class="keyword">if</span> (dbuf == <span class="literal">NULL</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((fd = open(pathname, O_RDONLY)) == <span class="number">-1</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (read(fd, dbuf, size) != (<span class="keyword">ssize_t</span>) size) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="built_in">memcmp</span>(buf, dbuf, size) == <span class="number">0</span>) &#123;</div><div class="line">                tz = getZoneName(pathname);</div><div class="line">                <span class="keyword">if</span> (tz != <span class="literal">NULL</span>) &#123;</div><div class="line">                    tz = strdup(tz);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">free</span>((<span class="keyword">void</span> *) dbuf);</div><div class="line">            dbuf = <span class="literal">NULL</span>;</div><div class="line">            (<span class="keyword">void</span>) close(fd);</div><div class="line">            fd = <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">free</span>((<span class="keyword">void</span> *) pathname);</div><div class="line">        pathname = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (entry != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="built_in">free</span>((<span class="keyword">void</span> *) entry);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (dirp != <span class="literal">NULL</span>) &#123;</div><div class="line">        (<span class="keyword">void</span>) closedir(dirp);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pathname != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="built_in">free</span>((<span class="keyword">void</span> *) pathname);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</div><div class="line">        (<span class="keyword">void</span>) close(fd);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (dbuf != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="built_in">free</span>((<span class="keyword">void</span> *) dbuf);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> tz;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">struct</span> stat statbuf;	    </div><div class="line">    <span class="keyword">char</span> *tz = <span class="literal">NULL</span>;</div><div class="line">    FILE *fp;</div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">char</span> *buf;</div><div class="line">    <span class="keyword">size_t</span> size;</div><div class="line">    <span class="keyword">if</span> ((fd = open(DEFAULT_ZONEINFO_FILE, O_RDONLY)) == <span class="number">-1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (fstat(fd, &amp;statbuf) == <span class="number">-1</span>) &#123;</div><div class="line">        (<span class="keyword">void</span>) close(fd);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    size = (<span class="keyword">size_t</span>) statbuf.st_size;</div><div class="line">    buf = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(size);</div><div class="line">    <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123;</div><div class="line">        (<span class="keyword">void</span>) close(fd);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (read(fd, buf, size) != (<span class="keyword">ssize_t</span>) size) &#123;</div><div class="line">        (<span class="keyword">void</span>) close(fd);</div><div class="line">        <span class="built_in">free</span>((<span class="keyword">void</span> *) buf);</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    (<span class="keyword">void</span>) close(fd);</div><div class="line"></div><div class="line">    tz = findZoneinfoFile(buf, size, ZONEINFO_DIR);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, tz);</div><div class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *) buf);</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>  docker 仓库上centos:7的基础镜像一直在更新，虽然是都叫centos：7但是一直都在默默的更新着，处于可控性考虑，还是得自己从头做一个基础镜像，为了彻底解决java时区问题，删除镜像localtime的同时，挂载localtime和／user／share／zoneinfo</p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'yihuangcaia';
var disqus_identifier = '2018/12/30/java-timezon/';
var disqus_title = 'docker java 时区';
var disqus_url = 'http://chellynov.github.io/2018/12/30/java-timezon/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>