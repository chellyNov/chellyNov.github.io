<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>libco stackoverflow | 鱼塘...</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2017-09-05</div></div></div><div class="post-header"><h1>libco stackoverflow</h1></div><div class="container post-content"><p>几个月前突然想看下协程相关的东西，于是下了demo跑了起来，测试代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"co_routine.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;hircluster.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">testRedis</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</div><div class="line">	co_enable_hook_sys();</div><div class="line">	<span class="keyword">int</span> * i = (<span class="keyword">int</span> *)arg;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *key=<span class="string">"key-a"</span>;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *field=<span class="string">"field-1"</span>;</div><div class="line">	<span class="keyword">const</span>   <span class="keyword">char</span> *key1=<span class="string">"key1"</span>;</div><div class="line">	<span class="keyword">const</span>  <span class="keyword">char</span> *value1=<span class="string">"value-1"</span>;</div><div class="line">	<span class="keyword">const</span>  <span class="keyword">char</span> *key2=<span class="string">"key1"</span>;</div><div class="line">	<span class="keyword">const</span>  <span class="keyword">char</span> *value2=<span class="string">"value-1"</span>;</div><div class="line">	    redisClusterContext *cc;</div><div class="line"></div><div class="line">	    cc = redisClusterContextInit();</div><div class="line">	    redisClusterSetOptionAddNodes(cc, <span class="string">"192.168.122.185:30001,192.168.122.185:30002"</span>);</div><div class="line">	    redisClusterConnect2(cc);</div><div class="line">	    <span class="keyword">if</span>(cc == <span class="literal">NULL</span> || cc-&gt;err)</div><div class="line">	    &#123;</div><div class="line"></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    redisReply *reply = (redisReply *)redisClusterCommand(cc, <span class="string">"hmget %s %s"</span>, key, field);</div><div class="line">	    <span class="keyword">if</span>(reply == <span class="literal">NULL</span>)</div><div class="line">	    &#123;</div><div class="line">	        <span class="built_in">cout</span>&lt;&lt; cc-&gt;errstr &lt;&lt; <span class="built_in">endl</span>; ;</div><div class="line">	        redisClusterFree(cc);</div><div class="line"></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> cnt = atoi( argv[<span class="number">1</span>] );</div><div class="line">	<span class="keyword">int</span> proccnt = atoi( argv[<span class="number">2</span>] );</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;cnt;i++)&#123;</div><div class="line">				stCoRoutine_t *co = <span class="number">0</span>;</div><div class="line">				co_create( &amp;co,<span class="literal">NULL</span>, testRedis, &amp;i);</div><div class="line">				co_resume( co );</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	co_eventloop( co_get_epoll_ct(),<span class="number">0</span>,<span class="number">0</span> );</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>刚跑起来就core了</p>
<blockquote>
<p>(gdb) bt</p>
<p>#0  0x00007fdfdf04bc90 in ?? ()</p>
<p>#1  0x00007fdfdeb20d9c in co_eventloop (ctx=0x25cdac0, pfn=0x0, arg=0x0)<br>    at co_routine.cpp:779</p>
<p>#2  0x000000000041021a in main (argc=3, argv=0x7ffcec531b28)<br>    at /home/cai/soft/cppserver-c7/server/brocaststat/src/BrocastStat.cpp:58</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret;i++)</div><div class="line">&#123;</div><div class="line">	stTimeoutItem_t *item = (stTimeoutItem_t*)result-&gt;events[i].data.ptr;</div><div class="line">	<span class="keyword">if</span>( item-&gt;pfnPrepare )</div><div class="line">	&#123;</div><div class="line">		item-&gt;pfnPrepare( item,result-&gt;events[i],active );<span class="comment">//出问题代码</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		AddTail( active,item );</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是libco的内部函数，于是debug了下，发现初始化的时候地址是正常的，但是经过协程切换后这个函数地址的前几位被截断了，导致了地址失效。于是跑libco的example，一切正常，函数地址没有被截断。<br>所以问题就缩小到了切换协程的地方了，但是暂时没啥头绪，也搜不到相关的资料（libco的资料实在太少了）。</p>
<h3 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h3><p>某天晚上闲的发慌于是就翻了libco的源码，发现在初始化的时候，协程栈只有128k，也没看到扩容的地方，于是联想到是不是爆栈了，于是调大了栈后问题真的没出现了</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><blockquote>
<p>Breakpoint 1, save_stack_buffer (occupy_co=0x636790) at co_routine.cpp:584<br>584        stStackMem_t* stack_mem = occupy_co-&gt;stack_mem;<br>Missing separate debuginfos, use: debuginfo-install apr-1.4.8-3.el7.x86_64 apr-util-1.5.2-6.el7.x86_64 cyrus-sasl-lib-2.1.26-20.el7_2.x86_64 expat-2.1.0-10.el7_3.x86_64 glibc-2.17-157.el7_3.5.x86_64 libdb-5.3.21-19.el7.x86_64 libgcc-4.8.5-11.el7.x86_64 libstdc++-4.8.5-11.el7.x86_64 libuuid-2.23.2-26.el7_2.3.x86_64 nspr-4.11.0-1.el7_2.x86_64 nss-3.21.0-9.el7_2.x86_64 nss-softokn-freebl-3.16.2.3-14.4.el7.x86_64 nss-util-3.21.0-2.2.el7_2.x86_64 openldap-2.4.40-9.el7_2.x86_64 protobuf-2.5.0-8.el7.x86_64 zlib-1.2.7-17.el7.x86_64<br>(gdb) n<br>585        int len = stack_mem-&gt;stack_bp - occupy_co-&gt;stack_sp;<br>(gdb) n<br>587        if (occupy_co-&gt;save_buffer)<br>(gdb) p len<br>$1 = 148777</p>
</blockquote>
<p>断点打在保存协程栈的函数,发现len是148777也就是145.29004kb，但是实际执行的只有128k，所以当协程切换的时候128k之外的就会被截断。讲道理libco是优化下，做栈自动扩容的，这个能避免不少坑，或者抛个异常到上层终止程序也好。</p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'yihuangcaia';
var disqus_identifier = '2017/09/05/libco-stackoverflow/';
var disqus_title = 'libco stackoverflow';
var disqus_url = 'http://chellynov.github.io/2017/09/05/libco-stackoverflow/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>