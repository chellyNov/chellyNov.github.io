<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>uwsgi django Ice.py reload segmentation fault | Cai...</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2017-02-22</div><div class="post-tags"><a class="post-tag-link" href="/tags/uwsgi/">uwsgi</a><a class="post-tag-link" href="/tags/zeroc-ice/">zeroc ice</a></div></div></div><div class="container post-header"><h1>uwsgi django Ice.py reload segmentation fault</h1></div><div class="container post-content"><p><a href="https://doc.zeroc.com/" target="_blank" rel="external">zeroc ice</a>是一个rpc框架,广泛应用于我们后台服务，在<a href="https://uwsgi-docs.readthedocs.io/en/latest/" target="_blank" rel="external">uwsgi</a>+<a href="https://www.djangoproject.com/" target="_blank" rel="external">django</a>使用icepy(ice python是在ice c++的基础上封装了一层供python使用，代码是v3.6.3)的时候遇到了下面这个问题</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Gracefully killing worker <span class="number">20</span> (pid: <span class="number">36213</span>)...</div><div class="line">!! <span class="number">02</span>/<span class="number">14</span>/<span class="number">17</span> <span class="number">09</span>:<span class="number">55</span>:<span class="number">41.823</span> error: <span class="number">2</span> communicators not destroyed during global destruction.!!! uWSGI process <span class="number">36213</span> got Segmentation Fault !!!</div><div class="line">*** backtrace of <span class="number">36213</span> ***</div><div class="line">uwsgi(uwsgi_backtrace+<span class="number">0x2e</span>) [<span class="number">0x469e0e</span>]</div><div class="line">uwsgi(uwsgi_segfault+<span class="number">0x21</span>) [<span class="number">0x46a1a1</span>]</div><div class="line">/usr/lib64/libc.so<span class="number">.6</span>(+<span class="number">0x35250</span>) [<span class="number">0x7f9c52192250</span>]</div><div class="line">/usr/lib64/python2<span class="number">.7</span>/site-packages/IcePy.so(_ZN3Ice6upCastEPNS_6LoggerE+<span class="number">0x8</span>) [<span class="number">0x7f9c45430458</span>]</div><div class="line">/usr/lib64/python2<span class="number">.7</span>/site-packages/IcePy.so(_ZN3Ice16setProcessLoggerERKN11IceInternal6HandleINS_6LoggerEEE+<span class="number">0xc2</span>) [<span class="number">0x7f9c453bd9f2</span>]</div><div class="line">/usr/lib64/python2<span class="number">.7</span>/site-packages/IcePy.so(_ZN5IcePy13cleanupLoggerEv+<span class="number">0x29</span>) [<span class="number">0x7f9c452ed669</span>]</div><div class="line">/usr/lib64/python2<span class="number">.7</span>/site-packages/IcePy.so(IcePy_cleanup+<span class="number">0x9</span>) [<span class="number">0x7f9c452ec039</span>]</div><div class="line">/usr/lib64/libpython2<span class="number">.7</span>.so<span class="number">.1</span><span class="number">.0</span>(PyEval_EvalFrameEx+<span class="number">0x730a</span>) [<span class="number">0x7f9c5283a00a</span>]</div><div class="line">/usr/lib64/libpython2<span class="number">.7</span>.so<span class="number">.1</span><span class="number">.0</span>(PyEval_EvalCodeEx+<span class="number">0x7ed</span>) [<span class="number">0x7f9c5283be3d</span>]</div><div class="line">/usr/lib64/libpython2<span class="number">.7</span>.so<span class="number">.1</span><span class="number">.0</span>(+<span class="number">0x70798</span>) [<span class="number">0x7f9c527c5798</span>]</div><div class="line">/usr/lib64/libpython2<span class="number">.7</span>.so<span class="number">.1</span><span class="number">.0</span>(PyObject_Call+<span class="number">0x43</span>) [<span class="number">0x7f9c527a08e3</span>]</div><div class="line">/usr/lib64/libpython2<span class="number">.7</span>.so<span class="number">.1</span><span class="number">.0</span>(PyEval_CallObjectWithKeywords+<span class="number">0x47</span>) [<span class="number">0x7f9c528326f7</span>]</div><div class="line">/usr/lib64/libpython2<span class="number">.7</span>.so<span class="number">.1</span><span class="number">.0</span>(Py_Finalize+<span class="number">0xb7</span>) [<span class="number">0x7f9c52856f87</span>]</div><div class="line">uwsgi(uwsgi_plugins_atexit+<span class="number">0x71</span>) [<span class="number">0x467161</span>]</div><div class="line">/usr/lib64/libc.so<span class="number">.6</span>(+<span class="number">0x38a49</span>) [<span class="number">0x7f9c52195a49</span>]</div><div class="line">/usr/lib64/libc.so<span class="number">.6</span>(+<span class="number">0x38a95</span>) [<span class="number">0x7f9c52195a95</span>]</div><div class="line">uwsgi() [<span class="number">0x421b2f</span>]</div></pre></td></tr></table></figure>
<p>这个是在uwsgi reload的时候引起的，先说下error: communicator not destroyed during global destruction。这个是细究起来也是有点长的，不过这文章的重点不是这个，所以简单说明下，这个是在程序调用exit()结束的时候，执行~Init()函数打印的日志</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">~Init()</div><div class="line">  &#123;</div><div class="line">      &#123;</div><div class="line">          IceUtilInternal::MutexPtrLock&lt;IceUtil::Mutex&gt; sync(staticMutex);</div><div class="line">          <span class="keyword">int</span> notDestroyedCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">          <span class="keyword">for</span>(<span class="built_in">std</span>::<span class="built_in">list</span>&lt;IceInternal::Instance*&gt;::const_iterator p = instanceList-&gt;begin();</div><div class="line">              p != instanceList-&gt;end(); ++p)</div><div class="line">          &#123;</div><div class="line">              <span class="keyword">if</span>(!(*p)-&gt;destroyed())</div><div class="line">              &#123;</div><div class="line">                  notDestroyedCount++;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span>(notDestroyedCount &gt; <span class="number">0</span>)</div><div class="line">          &#123;</div><div class="line">              <span class="built_in">cerr</span> &lt;&lt; <span class="string">"!! "</span> &lt;&lt; IceUtil::Time::now().toDateTime() &lt;&lt; <span class="string">" error: "</span>;</div><div class="line">              <span class="keyword">if</span>(notDestroyedCount == <span class="number">1</span>)</div><div class="line">              &#123;</div><div class="line">                  <span class="built_in">cerr</span> &lt;&lt; <span class="string">"communicator "</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">else</span></div><div class="line">              &#123;</div><div class="line">                  <span class="built_in">cerr</span> &lt;&lt; notDestroyedCount &lt;&lt; <span class="string">" communicators "</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="built_in">cerr</span> &lt;&lt; <span class="string">"not destroyed during global destruction."</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">delete</span> instanceList;</div><div class="line">          instanceList = <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">delete</span> staticMutex;</div><div class="line">      staticMutex = <span class="number">0</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>如果调用这函数但是communicator没有被destroy就会出现这个log。</p>
<p>现在开始讲重点了，看懂上面那个错误堆栈需要使用c++filt这个工具</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ c++filt _ZN3Ice6upCastEPNS_6LoggerE</div><div class="line">Ice::upCast(Ice::Logger*)</div><div class="line">$ c++filt _ZN3Ice16setProcessLoggerERKN11IceInternal6HandleINS_6LoggerEEE</div><div class="line">Ice::setProcessLogger(IceInternal::Handle&lt;Ice::Logger&gt; <span class="keyword">const</span>&amp;)</div><div class="line">$ c++filt _ZN5IcePy13cleanupLoggerEv</div><div class="line">IcePy::cleanupLogger()</div></pre></td></tr></table></figure>
<p>这里就把函数签名转换成代码里面具体的方法名了，以下是这个堆栈的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">typedef</span> ::IceInternal::Handle&lt; ::Ice::Logger&gt; LoggerPtr;</div><div class="line">Ice::LoggerPtr processLogger;</div><div class="line"><span class="keyword">void</span> IcePy::cleanupLogger()</div><div class="line">&#123;</div><div class="line">	Ice::setProcessLogger(<span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Ice::setProcessLogger(<span class="keyword">const</span> LoggerPtr&amp; logger)</div><div class="line">&#123;</div><div class="line">	IceUtilInternal::MutexPtrLock&lt;IceUtil::Mutex&gt; lock(globalMutex);</div><div class="line">	processLogger = logger;</div><div class="line">	&#125;</div><div class="line">	ICE_API ::Ice::LocalObject* Ice::upCast(::Ice::Logger* p)&#123; <span class="keyword">return</span> p; &#125;</div></pre></td></tr></table></figure>
<p>Handle是ice封装的一个智能指针类，重载了operator= 以下是相关代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">  ~Handle()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;_ptr)</div><div class="line">        &#123;</div><div class="line">            upCast(<span class="keyword">this</span>-&gt;_ptr)-&gt;__decRef();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Handle&amp; <span class="keyword">operator</span>=(T* p)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;_ptr != p)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>(p)</div><div class="line">            &#123;</div><div class="line">                upCast(p)-&gt;__incRef();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            T* ptr = <span class="keyword">this</span>-&gt;_ptr;</div><div class="line">            <span class="keyword">this</span>-&gt;_ptr = p;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(ptr)</div><div class="line">            &#123;</div><div class="line">                upCast(ptr)-&gt;__decRef();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span></div><div class="line">IceUtil::Shared::__decRef()</div><div class="line">&#123;</div><div class="line">    assert(_ref &gt; <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span>(--_ref == <span class="number">0</span> &amp;&amp; !(_flags &amp; NoDelete))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看代码的话，我们调用了setProcessLogger(0)，所以operator=函数里面调用了upcast()的情况只可能是ptr不为0的时候，但是光是空想并不知道为啥出了问题，于是用了gdb debug，gdb脾气不是特别好，我前几次使用他都无缘无故卡住了，或者直接没进到断点。所以搁置一天，然而还是不死心，于是继续尝试用gdb debug，估计前几次是我运气太背，后来几次debug都挺顺畅的，小概率出现进程卡死的情况。</p>
<p>所以在Ice::setProcessLogger这函数打了断点 gdb debug几次之后均显示ptr这个地址不为0，苦思无果，于是断断续续利用零散的时间debug，直到把断点打到Ice::upCast(::Ice::Logger* p)这个函数，发现upcast已经在~Handle()执行过一次了，于是突然想到会不会是这个析构后把ptr这东西给释放了之类的，导致这个地址的引用失败了，于是跳进~Handle()的__decRef();</p>
<p><img src="gdb.png" alt="gdb"></p>
<p>执行的57行也就是上面__decRef函数的 delete this;这句话了，所以估计就是因为被析构后引用了个无效的地址了。</p>
<h3 id="关于解决方式"><a href="#关于解决方式" class="headerlink" title="关于解决方式"></a>关于解决方式</h3><p>其实reload后，进程都被杀掉了，不管也是可以的，如果不想看到这个错误堆栈的话 注释掉Ice.py下面这两行代码就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> atexit</div><div class="line">atexit.register(IcePy.cleanup)</div></pre></td></tr></table></figure>
<h3 id="关于processLogger的生命周期与atexit"><a href="#关于processLogger的生命周期与atexit" class="headerlink" title="关于processLogger的生命周期与atexit"></a>关于processLogger的生命周期与atexit</h3><p>uwsgi注册了若干atexit函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">// fallback config</span></div><div class="line">atexit(uwsgi_fallback_config);</div><div class="line"><span class="comment">// manage/flush logs</span></div><div class="line">atexit(uwsgi_flush_logs);</div><div class="line"><span class="comment">// clear sockets, pidfiles...</span></div><div class="line">atexit(vacuum);</div><div class="line"><span class="comment">// call user scripts</span></div><div class="line">atexit(uwsgi_exec_atexit);</div><div class="line"><span class="comment">// call plugin specific exit hooks</span></div><div class="line">atexit(uwsgi_plugins_atexit);</div></pre></td></tr></table></figure>
<p>调用cleanup的代码正是被uwsgi_plugins_atexit这个函数调用的，看代码的话就有个疑问了，processLogger是个全局变量，按道理应该是在atexit执行之后才被析构，但是实际上是析构在前，于是推测是不是因为uwsgi 调用python的关系，所以在启动uwsgi并且成功请求一次之前和之后各打印processLogger（如果不请求的话，uwsgi是不会加载相关python代码的）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">(gdb) p   'Initialize.cpp'::processLogger</div><div class="line">No symbol "Initialize.cpp" in current context.</div><div class="line"></div><div class="line">(gdb) p   'Initialize.cpp'::processLogger</div><div class="line">$5 = &#123;&lt;IceUtil::HandleBase&lt;Ice::Logger&gt;&gt; = &#123;</div><div class="line">    _ptr = 0x29e8f60&#125;, &lt;No data fields&gt;&#125;</div></pre></td></tr></table></figure>
<p>事实说明processLogger要在加载python相关代码后才初始化，于是在Handle.h的构造函数打下断点，在uwsgi 启动后第一次请求触发断点，得到以下堆栈</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">Handle (p=0x0, this=0x7f2a2ff7bc00 &lt;(anonymous namespace)::processLogger&gt;)</div><div class="line">    at src/ice/cpp/include/Ice/Handle.h:42</div><div class="line">42	src/ice/cpp/include/Ice/Handle.h: 没有那个文件或目录.</div><div class="line">(gdb) bt</div><div class="line">#0  Handle (p=0x0, this=0x7f2a2ff7bc00 &lt;(anonymous namespace)::processLogger&gt;)</div><div class="line">    at src/ice/cpp/include/Ice/Handle.h:42</div><div class="line">#1  __static_initialization_and_destruction_0 (__initialize_p=1,</div><div class="line">    __priority=65535) at src/ice/cpp/src/Ice/Initialize.cpp:45</div><div class="line">#2  _GLOBAL__sub_I_Initialize.cpp(void) ()</div><div class="line">    at src/ice/cpp/src/Ice/Initialize.cpp:538</div><div class="line">#3  0x00007f2a3e22e1e3 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2</div><div class="line">#4  0x00007f2a3e2328f6 in dl_open_worker () from /lib64/ld-linux-x86-64.so.2</div><div class="line">#5  0x00007f2a3e22dff4 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2</div><div class="line">#6  0x00007f2a3e231feb in _dl_open () from /lib64/ld-linux-x86-64.so.2</div><div class="line">#7  0x00007f2a3dafdfbb in dlopen_doit () from /usr/lib64/libdl.so.2</div><div class="line">#8  0x00007f2a3e22dff4 in _dl_catch_error () from /lib64/ld-linux-x86-64.so.2</div><div class="line">#9  0x00007f2a3dafe5bd in _dlerror_run () from /usr/lib64/libdl.so.2</div><div class="line">#10 0x00007f2a3dafe051 in dlopen@@GLIBC_2.2.5 () from /usr/lib64/libdl.so.2</div><div class="line">#11 0x00007f2a3cb7122f in _PyImport_GetDynLoadFunc ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#12 0x00007f2a3cb59b3e in _PyImport_LoadDynamicModule ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#13 0x00007f2a3cb57c41 in import_submodule ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#14 0x00007f2a3cb57e8d in load_next () from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#15 0x00007f2a3cb5886e in PyImport_ImportModuleLevel ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---</div><div class="line">#16 0x00007f2a3cb3bb1f in builtin___import__ ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#17 0x00007f2a3caab8e3 in PyObject_Call () from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#18 0x00007f2a3cb3d6f7 in PyEval_CallObjectWithKeywords ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#19 0x00007f2a3cb423b5 in PyEval_EvalFrameEx ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#20 0x00007f2a3cb46e3d in PyEval_EvalCodeEx ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#21 0x00007f2a3cb46f42 in PyEval_EvalCode ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#22 0x00007f2a3cb56d2c in PyImport_ExecCodeModuleEx ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#23 0x00007f2a3cb56fa8 in load_source_module ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#24 0x00007f2a3cb57c41 in import_submodule ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#25 0x00007f2a3cb57f26 in load_next () from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#26 0x00007f2a3cb5886e in PyImport_ImportModuleLevel ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#27 0x00007f2a3cb3bb1f in builtin___import__ ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#28 0x00007f2a3caab8e3 in PyObject_Call () from /usr/lib64/libpython2.7.so.1.0</div><div class="line">---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---</div><div class="line">#29 0x00007f2a3cb3d6f7 in PyEval_CallObjectWithKeywords ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#30 0x00007f2a3cb423b5 in PyEval_EvalFrameEx ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#31 0x00007f2a3cb46e3d in PyEval_EvalCodeEx ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#32 0x00007f2a3cb46f42 in PyEval_EvalCode ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#33 0x00007f2a3cb56d2c in PyImport_ExecCodeModuleEx ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#34 0x00007f2a3cb56fa8 in load_source_module ()</div><div class="line">   from /usr/lib64/libpython2.7.so.1.0</div><div class="line">#35 0x00007f2a3cb57c41 in import_submodule ()</div></pre></td></tr></table></figure>
<p>所以processLogger的生命周期从加载uwsgi python相关动态库开始，在atexit之前结束，所以估计是和uwsgi python加载的动态库的生命周期是相关的<br>但是debug的时候没发现调用了dlclose，所以为啥会在atexit之前析构暂时没弄懂</p>
</div></div><div class="post-main post-comment"><div data-thread-key="2017/02/22/uwsgi-ice-seg-fault/" data-title="uwsgi django Ice.py reload segmentation fault" data-url="http://chellynov.github.io/2017/02/22/uwsgi-ice-seg-fault/" class="ds-thread"></div><script>var duoshuoQuery = {short_name:'novchelly'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>