<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>python生成cpu火焰图 | 鱼塘...</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2017-04-18</div></div></div><div class="container post-header"><h1>python生成cpu火焰图</h1></div><div class="container post-content"><p>使用火焰图定位cpu性能问题是一种实用的手段，可以简单的从火焰图中看出性能的瓶颈点，cpu火焰图有<a href="!http://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html">on cpu</a>  <a href="!http://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html">off cpu</a> 两种模式。前些日子发现有个python的性能问题需要分析，于是搜到<a href="https://github.com/rfyiamcool/profiler_online" target="_blank" rel="external">profiler_online</a> 这个开源项目</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>pypi<br>pip install profiler_online<br>源码安装<br>git clone <a href="https://github.com/rfyiamcool/profiler_online.git" target="_blank" rel="external">https://github.com/rfyiamcool/profiler_online.git</a><br>cd profiler_online<br>python setup.py install</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>在项目引入:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</div><div class="line"><span class="keyword">from</span> profiler_online <span class="keyword">import</span> run_profiler</div><div class="line">monkey.patch_all()</div><div class="line">run_profiler()</div></pre></td></tr></table></figure></p>
<p>run_profiler支持三个参数:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">debug_config = &#123;</div><div class="line">    'host': '127.0.0.1',</div><div class="line">    'port': 8080,</div><div class="line">    'tmp_path: '/tmp/debug'</div><div class="line">&#125;</div><div class="line">run_profiler(**debug_config)</div></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>打开浏览器 <a href="http://127.0.0.1:8080" target="_blank" rel="external">http://127.0.0.1:8080</a> 或者wget <a href="http://127.0.0.1:8080，这样就可以显示正在运行服务的性能火焰图了" target="_blank" rel="external">http://127.0.0.1:8080，这样就可以显示正在运行服务的性能火焰图了</a>.<br><img src="pika_cpu_flame.svg" alt=""></p>
<h2 id="profiler-online收集堆栈代码分析"><a href="#profiler-online收集堆栈代码分析" class="headerlink" title="profiler_online收集堆栈代码分析"></a>profiler_online收集堆栈代码分析</h2><p>profiler_online是通过signal.setitimer这个函数间隔0.005s收集一次堆栈 然后使用<a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="external">FlameGraph</a>生成火焰图展示到浏览器web上面<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">        self._started = time.time()</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line"></div><div class="line">            signal.signal(signal.SIGVTALRM, self._sample)</div><div class="line"></div><div class="line">        <span class="keyword">except</span> ValueError:</div><div class="line"></div><div class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Can only sample on the main thread'</span>)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        signal.setitimer(signal.ITIMER_VIRTUAL, self.interval, <span class="number">0</span>)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_sample</span><span class="params">(self, signum, frame)</span>:</span></div><div class="line"></div><div class="line">        stack = []</div><div class="line"></div><div class="line">        <span class="keyword">while</span> frame <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line"></div><div class="line">            stack.append(self._format_frame(frame))</div><div class="line"></div><div class="line">            frame = frame.f_back</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        stack = <span class="string">';'</span>.join(reversed(stack))</div><div class="line"></div><div class="line">        self._stack_counts[stack] += <span class="number">1</span></div><div class="line"></div><div class="line">        signal.setitimer(signal.ITIMER_VIRTUAL, self.interval, <span class="number">0</span>)<span class="comment">#interval=0.005</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_format_frame</span><span class="params">(self, frame)</span>:</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;(&#123;&#125;)'</span>.format(frame.f_code.co_name,</div><div class="line"></div><div class="line">                               frame.f_globals.get(<span class="string">'__name__'</span>))</div></pre></td></tr></table></figure></p>
<h2 id="其他python性能分析方式"><a href="#其他python性能分析方式" class="headerlink" title="其他python性能分析方式"></a>其他python性能分析方式</h2><p><a href="https://mp.weixin.qq.com/s?__biz=MzA4MjEyNTA5Mw==&amp;mid=2652565088&amp;idx=1&amp;sn=52803bc8aa03dac6ee3addfa9092b18b&amp;chksm=8464c62ab3134f3c06362ed086db78047e27cad78b439c246878f1f506b1c73360a7a565cabd&amp;mpshare=1&amp;scene=1&amp;srcid=0418xj017jNXCUe6HrG3JBNu&amp;key=b10fba77b8c1acc9af4afc55072d94cd80f1401c4bcb8d8bd43ca7f733760b8e32f7537fc6e06ab7d7661acd88eb049e66e01bba10912058c0a522dbefbb3bd5df6a7f508670dd3f81f2614397f749b5&amp;ascene=0&amp;uin=ODM3NTEwMDAw&amp;version=12020110&amp;nettype=WIFI&amp;fontScale=100&amp;pass_ticket=uj27XiwRYDHmAI5slQB2ifaUrUS%2BQRZP7mcUGUi%2FVJ33VslqF3kB8nGErKLgqJjC" target="_blank" rel="external">Python 优化第一步: 性能分析实践</a><br>里面提到了<a href="https://github.com/nvdv/vprof" target="_blank" rel="external">vprof</a>这个火焰图工具，这个比profiler_online强大不少，不仅可以收集cpu火焰图还可以收集内存火焰图，代码执行时间等，收集的粒度比profiler_online细了不少，不过相对的影响的性能也大了些。 本来想写vprof的，不过生成出来的火焰图太难用了～</p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'yihuangcaia';
var disqus_identifier = '2017/04/18/python-cpu-flame/';
var disqus_title = 'python生成cpu火焰图';
var disqus_url = 'http://chellynov.github.io/2017/04/18/python-cpu-flame/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>