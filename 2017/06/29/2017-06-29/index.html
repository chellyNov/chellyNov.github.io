<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>couchbase 埋坑（2） | 鱼塘...</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2017-06-29</div></div></div><div class="post-header"><h1>couchbase 埋坑（2）</h1></div><div class="container post-content"><p>为什么是2呢，因为以前写过一篇couchbase 相关的坑了，而且其实遇到了好多乱七八糟的坑了，有精力写出来的话，还有 3和4</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>前段时间发现couchbase java sdk 2.2.6版本在测试环境一台机器挂掉之后，整个sdk就不能正常工作了，couchbase作为容灾性很强的集群，不应该会出现整个集群，所以估计是客户端有问题，所以下意识升级了版本，升级到2.4.5版本，顺利解决这个问题。正常运行了一个月之后，私有云的哥们某天反馈客户的环境一台机器挂了，服务的couchbase起不来，日志如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">56.459</span> [RxComputationScheduler-<span class="number">6</span>] WARN  [<span class="keyword">null</span>][KeyValueEndpoint]: Socket connect took longer than specified timeout.</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">56.460</span> [RxComputationScheduler-<span class="number">6</span>] WARN  Error during reconnect: </div><div class="line">com.couchbase.client.deps.io.netty.channel.ConnectTimeoutException: Connect callback did not <span class="keyword">return</span>, hit safeguarding timeout.</div><div class="line">	at com.couchbase.client.core.endpoint.AbstractEndpoint$<span class="number">3</span>.call(AbstractEndpoint.java:<span class="number">346</span>) ~[dev-api-v1.jar:na]</div><div class="line">	at com.couchbase.client.core.endpoint.AbstractEndpoint$<span class="number">3</span>.call(AbstractEndpoint.java:<span class="number">339</span>) ~[dev-api-v1.jar:na]</div><div class="line">	at rx.internal.operators.SingleOperatorOnErrorResumeNext$<span class="number">2</span>.onError(SingleOperatorOnErrorResumeNext.java:<span class="number">69</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.operators.SingleTimeout$TimeoutSingleSubscriber$OtherSubscriber.onError(SingleTimeout.java:<span class="number">133</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.Single$<span class="number">1</span>.call(Single.java:<span class="number">460</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.Single$<span class="number">1</span>.call(Single.java:<span class="number">456</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.operators.SingleTimeout$TimeoutSingleSubscriber.call(SingleTimeout.java:<span class="number">110</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.schedulers.EventLoopsScheduler$EventLoopWorker$<span class="number">2</span>.call(EventLoopsScheduler.java:<span class="number">189</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:<span class="number">55</span>) [dev-api-v1.jar:na]</div><div class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">511</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$<span class="number">201</span>(ScheduledThreadPoolExecutor.java:<span class="number">180</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:<span class="number">293</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">56.460</span> [RxComputationScheduler-<span class="number">6</span>] WARN  [<span class="keyword">null</span>][KeyValueEndpoint]: Could not connect to endpoint, retrying with delay <span class="number">4096</span> MILLISECONDS: </div><div class="line">com.couchbase.client.deps.io.netty.channel.ConnectTimeoutException: Connect callback did not <span class="keyword">return</span>, hit safeguarding timeout.</div><div class="line">	at com.couchbase.client.core.endpoint.AbstractEndpoint$<span class="number">3</span>.call(AbstractEndpoint.java:<span class="number">346</span>) ~[dev-api-v1.jar:na]</div><div class="line">	at com.couchbase.client.core.endpoint.AbstractEndpoint$<span class="number">3</span>.call(AbstractEndpoint.java:<span class="number">339</span>) ~[dev-api-v1.jar:na]</div><div class="line">	at rx.internal.operators.SingleOperatorOnErrorResumeNext$<span class="number">2</span>.onError(SingleOperatorOnErrorResumeNext.java:<span class="number">69</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.operators.SingleTimeout$TimeoutSingleSubscriber$OtherSubscriber.onError(SingleTimeout.java:<span class="number">133</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.Single$<span class="number">1</span>.call(Single.java:<span class="number">460</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.Single$<span class="number">1</span>.call(Single.java:<span class="number">456</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.operators.SingleTimeout$TimeoutSingleSubscriber.call(SingleTimeout.java:<span class="number">110</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.schedulers.EventLoopsScheduler$EventLoopWorker$<span class="number">2</span>.call(EventLoopsScheduler.java:<span class="number">189</span>) [dev-api-v1.jar:na]</div><div class="line">	at rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:<span class="number">55</span>) [dev-api-v1.jar:na]</div><div class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">511</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$<span class="number">201</span>(ScheduledThreadPoolExecutor.java:<span class="number">180</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:<span class="number">293</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>) [na:<span class="number">1.8</span>.0_121]</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57.290</span> [cb-io-<span class="number">1</span>-<span class="number">4</span>] WARN  [<span class="keyword">null</span>][ConfigEndpoint]: Socket connect took longer than specified timeout.</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57.733</span> [cb-io-<span class="number">1</span>-<span class="number">5</span>] INFO  [<span class="keyword">null</span>][KeyValueEndpoint]: Got notified from Channel as inactive, attempting reconnect.</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57.734</span> [cb-io-<span class="number">1</span>-<span class="number">6</span>] INFO  [<span class="keyword">null</span>][KeyValueEndpoint]: Got notified from Channel as inactive, attempting reconnect.</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57.736</span> [cb-io-<span class="number">1</span>-<span class="number">7</span>] INFO  [<span class="keyword">null</span>][KeyValueEndpoint]: Got notified from Channel as inactive, attempting reconnect.</div><div class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57.738</span> [cb-io-<span class="number">1</span>-<span class="number">8</span>] INFO  [<span class="keyword">null</span>][KeyValueEndpoint]: Got notified from Channel as inactive, attempting reconnect.</div></pre></td></tr></table></figure>
<p>因为比较紧急，所以尝试回退到2.2.6这个版本看能不能解决问题,结果回退后正常运行。因为遇到太多次这样子了，所以下血本看下为啥会这样子。</p>
<h2 id="埋坑"><a href="#埋坑" class="headerlink" title="埋坑"></a>埋坑</h2><p>向运维申请了一个3个节点的couchbase集群，版本4.6.2,运行了用2.4.5版本的服务后， 手动把其中一个节点的进程fail over掉，发现一切正常，恢复后杀掉进程，也是一切正常。初步估计是和couchbase server版本有关。恰巧要去客户那里出差解决问题，于是出差期间在客户的环境tcpdump了出错版本的包和正常运行版本的包。客户的couchbase server版本是4.1.1，但是客户的集群只有两个节点，挂了一个后只剩下一个节点。后来想到这一点，又把测试环境的集群杀剩一个节点，果然也出问题了</p>
<h2 id="couchbase4-1抓包结果"><a href="#couchbase4-1抓包结果" class="headerlink" title="couchbase4.1抓包结果"></a>couchbase4.1抓包结果</h2><p>couchbase java sdk 2.2.6 正常运行,可以看到hello request后立马返回一个hello resp,然后接下来会获取集群信息等的进一步操作</p>
<p><img src="coucbaseok.png" alt=""></p>
<p>coucbase java sdk 2.4.5 初始化不了，无法正常工作，可以看到hello request后，服务端没有resp返回，所以客户端会重试的发hello到一定次数后就不再重试。所以下来的一系列初始化都不会进行了，客户端自然而然的不能工作了</p>
<p><img src="couchbaseerr.png" alt=""></p>
<p>仔细对比两个hello包，发现除了body 其他都一样，但是在一个节点的时候，2.4.5 hello request就是没有resp。</p>
<h2 id="couchbase4-6抓包结果"><a href="#couchbase4-6抓包结果" class="headerlink" title="couchbase4.6抓包结果"></a>couchbase4.6抓包结果</h2><p>couchbase java sdk 2.2.6 初始化不了,可以看到hello request后立马返回一个hello resp,然后接下来会获取集群信息等的进一步操作，但是拉取到了192.168.248.43这台机器上的couchbase已经被杀掉了，所以后续sdk去连这台机器的时候也连接不上，所以也初始化不了。<br><img src="2.2.6-4.6.png" alt=""></p>
<p>couchbase java sdk 2.4.5 初始化不了,可以看到hello request后立马返回一个hello resp,然后接下来会获取集群信息等的进一步操作，但是拉取到了192.168.248.43这台机器上的couchbase已经被杀掉了，所以后续sdk去连这台机器的时候也连接不上，所以也初始化不了。<br><img src="2.4.5-4.6.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在couchbase剩下一个节点的时候，基本都会出现这些问题，应该尽量保持在三个节点及以上</p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'yihuangcaia';
var disqus_identifier = '2017/06/29/2017-06-29/';
var disqus_title = 'couchbase 埋坑（2）';
var disqus_url = 'http://chellynov.github.io/2017/06/29/2017-06-29/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>