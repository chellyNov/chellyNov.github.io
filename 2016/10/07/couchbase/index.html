<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Couchbase java client 解析binary doc失败 | 鱼塘...</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></nav><div class="container post-meta"><div class="post-time">2016-10-07</div><div class="post-tags"><a class="post-tag-link" href="/tags/couchbase/">couchbase</a></div></div></div><div class="container post-header"><h1>Couchbase java client 解析binary doc失败</h1></div><div class="container post-content"><p>  内部模块的交互都是使用protobuf,所有有部分数据是存protobuf的bytes到couchbase里面,但是某天发现从coucbase里面取protobuf的binary数据后客户端解析失败:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Caused by: com.couchbase.client.java.error.TranscodingException: Flags (<span class="number">0x0</span>) indicate non-binary document <span class="keyword">for</span> id <span class="number">12307971</span>, could not decode.</div><div class="line">    at com.couchbase.client.java.transcoder.BinaryTranscoder.doDecode(BinaryTranscoder.java:<span class="number">38</span>) ~[imhttp-v1.jar:na]</div><div class="line">    at</div></pre></td></tr></table></figure>
<p>使用的couchbase java sdk版本是2.2.6 对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">protected</span> BinaryDocument <span class="title">doDecode</span><span class="params">(String id, ByteBuf content, <span class="keyword">long</span> cas, <span class="keyword">int</span> expiry, <span class="keyword">int</span> flags,</span></span></div><div class="line">     ResponseStatus status) <span class="keyword">throws</span> Exception &#123;</div><div class="line">     <span class="keyword">if</span> (!TranscoderUtils.hasBinaryFlags(flags)) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TranscodingException(<span class="string">"Flags (0x"</span> + Integer.toHexString(flags) + <span class="string">") indicate non-binary "</span> +</div><div class="line">             <span class="string">"document for id "</span> + id + <span class="string">", could not decode."</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> BinaryDocument.create(id, expiry, content, cas);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>查看couchbase解析response的源代码后发现flags是memcache协议中的一个字段</p>
<h3 id="关于flags"><a href="#关于flags" class="headerlink" title="关于flags"></a>关于flags</h3><p><a href="https://github.com/memcached/memcached/wiki/BinaryProtocolRevamped#get-get-quietly-get-key-get-key-quietly" target="_blank" rel="external">memcached 协议</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Byte/     <span class="number">0</span>       |       <span class="number">1</span>       |       <span class="number">2</span>       |       <span class="number">3</span>       |</div><div class="line">   /              |               |               |               |</div><div class="line">  |<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>|<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>|<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>|<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>|</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"> <span class="number">0</span>| <span class="number">0x81</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x05</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"> <span class="number">4</span>| <span class="number">0x04</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"> <span class="number">8</span>| <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x09</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">12</span>| <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">16</span>| <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">20</span>| <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x00</span>          | <span class="number">0x01</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">24</span>| <span class="number">0xde</span>          | <span class="number">0xad</span>          | <span class="number">0xbe</span>          | <span class="number">0xef</span>          |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">28</span>| <span class="number">0x48</span> (<span class="string">'H'</span>)    | <span class="number">0x65</span> (<span class="string">'e'</span>)    | <span class="number">0x6c</span> (<span class="string">'l'</span>)    | <span class="number">0x6c</span> (<span class="string">'l'</span>)    |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">32</span>| <span class="number">0x6f</span> (<span class="string">'o'</span>)    | <span class="number">0x57</span> (<span class="string">'W'</span>)    | <span class="number">0x6f</span> (<span class="string">'o'</span>)    | <span class="number">0x72</span> (<span class="string">'r'</span>)    |</div><div class="line">  +---------------+---------------+---------------+---------------+</div><div class="line"><span class="number">36</span>| <span class="number">0x6c</span> (<span class="string">'l'</span>)    | <span class="number">0x64</span> (<span class="string">'d'</span>)    |</div><div class="line">  +---------------+---------------+</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> Total <span class="number">38</span> bytes (<span class="number">24</span> <span class="keyword">byte</span> header, <span class="number">4</span> <span class="keyword">byte</span> extras, <span class="number">5</span> <span class="keyword">byte</span> key</div><div class="line">                 and <span class="number">5</span> <span class="keyword">byte</span> value)</div><div class="line">Field        (offset) (value)</div><div class="line">Magic        (<span class="number">0</span>)    : <span class="number">0x81</span></div><div class="line">Opcode       (<span class="number">1</span>)    : <span class="number">0x00</span></div><div class="line"><span class="function">Key <span class="title">length</span>   <span class="params">(<span class="number">2</span>,<span class="number">3</span>)</span>  : 0x0005</span></div><div class="line">Extra <span class="title">length</span> <span class="params">(<span class="number">4</span>)</span>    : 0x04</div><div class="line">Data <span class="title">type</span>    <span class="params">(<span class="number">5</span>)</span>    : 0x00</div><div class="line"><span class="title">Status</span>       <span class="params">(<span class="number">6</span>,<span class="number">7</span>)</span>  : 0x0000</div><div class="line">Total <span class="title">body</span>   <span class="params">(<span class="number">8</span><span class="number">-11</span>)</span> : 0x00000009</div><div class="line"><span class="title">Opaque</span>       <span class="params">(<span class="number">12</span><span class="number">-15</span>)</span>: 0x00000000</div><div class="line"><span class="title">CAS</span>          <span class="params">(<span class="number">16</span><span class="number">-23</span>)</span>: 0x0000000000000001</div><div class="line">Extras              :</div><div class="line"><span class="title">Flags</span>      <span class="params">(<span class="number">24</span><span class="number">-27</span>)</span>: 0xdeadbeef</div><div class="line"><span class="title">Key</span>          <span class="params">(<span class="number">28</span><span class="number">-32</span>)</span>: The textual string: "Hello"</div><div class="line"><span class="title">Value</span>        <span class="params">(<span class="number">33</span><span class="number">-37</span>)</span>: The textual string: "World"</div></pre></td></tr></table></figure>
<p>文档中没详细解释flags是什么用的，但是根据上面校验代码看，应该是是一个存储类型的校验字段。</p>
<p>所以只能继续看源码，查看源码后发现flags的值在add set replace的时候客户端就已经生成了，但是出错的那些数据都是没有flags字段的，由于这部分数据都是c sdk负责写的，所以怀疑是c sdk写数据的时候没有生成这个flags</p>
<p>c sdk写数据的抓包结果</p>
<p><img src="/image/couchbase.jpg" alt=""></p>
<p>所以这个问题是各个sdk行为不一致引起的，所以解决方法就是删掉那段校验的代码，重新打包就可以了</p>
<h3 id="备注：关于部分sdk的行为"><a href="#备注：关于部分sdk的行为" class="headerlink" title="备注：关于部分sdk的行为"></a>备注：关于部分sdk的行为</h3><p>c sdk的请求flags为0，也就是没有设置，get response也不校验flags的请求，所以无报错<br>python sdk add请求有设置flags的，get response不校验flags，所以也无报错<br>java sdk add 请求有设置flags， get response强校验flags，所以解析失败</p>
</div></div><div class="post-main post-comment"><div data-thread-key="2016/10/07/couchbase/" data-title="Couchbase java client 解析binary doc失败" data-url="http://chellynov.github.io/2016/10/07/couchbase/" class="ds-thread"></div><script>var duoshuoQuery = {short_name:'novchelly'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>